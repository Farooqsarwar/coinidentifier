name: Flutter iOS IPA Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-13

    env:
      FLUTTER_VERSION: "3.38.6"
      BUILD_NAME: "1.0.${{ github.run_number }}"
      BUILD_NUMBER: "${{ github.run_number }}"

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Set up Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      # 3Ô∏è‚É£ Enable iOS
      - name: Enable iOS
        run: flutter config --enable-ios

      # 4Ô∏è‚É£ Flutter pub get
      - name: Install dependencies
        run: flutter pub get

      # 5Ô∏è‚É£ Install CocoaPods
      - name: Install CocoaPods
        run: sudo gem install cocoapods

      # 6Ô∏è‚É£ Pod install
      - name: Pod install
        run: |
          cd ios
          pod install
          cd ..

      # 7Ô∏è‚É£ Update version and build numbers
      - name: Update Flutter build version
        run: flutter pub version ${{ env.BUILD_NAME }}+${{ env.BUILD_NUMBER }}

      # 8Ô∏è‚É£ Build IPA (archive)
      - name: Build iOS IPA
        run: |
          flutter build ipa \
            --release \
            --export-method app-store \
            --build-name=${{ env.BUILD_NAME }} \
            --build-number=${{ env.BUILD_NUMBER }}

      # 9Ô∏è‚É£ Upload IPA as artifact
      - name: Upload IPA
        uses: actions/upload-artifact@v3
        with:
          name: Runner.ipa
          path: build/ios/ipa/*.ipa

      # üîü Optional: Upload xcarchive if needed
      - name: Upload Xcode archive
        uses: actions/upload-artifact@v3
        with:
          name: Runner.xcarchive
          path: build/ios/archive/*.xcarchive
